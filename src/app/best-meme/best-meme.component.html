<div class="spinner" *ngIf="loading">
  ... loading
</div>

<app-greetings></app-greetings>
<header class="wrapper sticky-top">
  <app-popular-subreddits (choose)="fetchSub($event, 'fill')"></app-popular-subreddits>
  <ng-container [ngTemplateOutlet]="searchAndOptions"></ng-container>
</header>

<div *ngIf="!posts.length" class="recommendations">
  <h1>Empfohlene Subreddits:</h1>
  <h5>wähle einen Subreddit aus der Liste unten aus, oder aus den 100 beliebtesten Subreddit mit einem Klick auf den Button oben links!</h5>
  <h5>alternativ kannst du natürlich auch die Suchleiste oben benutzen (+optionen oben rechts) um selbstständig nach einem Subreddit zu suchen 😊</h5>
  <!-- todo: make this dynamic -->
  <div>
    <ul *ngFor="let rec of recommendations" [ngClass]="['suggestions', rec.category]">
      <h2>{{ rec.title }}</h2>
      <li *ngFor="let sug of rec.suggestions.slice(0, 5)"
        [class.private]="sug.private" (click)="sug.private ? onPrivateClick() : fetchSub(sug.name, 'fill')">
        <span class="subscriber-count">{{sug.subscribers | shortNumber}}</span>
        <span *ngIf="sug.icon_img?.length" class="icon-wrapper"><img [src]="sug.icon_img" alt="Subreddit Icon" class="img-icon"></span>
        <span *ngIf="sug.over18">🔞</span>
        {{sug.name}}</li>
    </ul>
  </div>
</div>

<div class="optionsOverlay toggle" (click)="hideOverlay($event)" #optionsOverlay>
  <div class="exit" (click)="onLeavingOptions(optionsOverlay)">x</div>
  <div>
    <form [formGroup]="postOptions" class="wrapper" novalidate>
      <label for="perPage">Anzahl Posts pro Seite:</label>
      <select name="perPage" id="perPage" formControlName="perPage">
        <option value="25">25</option>
        <option value="50">50</option>
        <option value="75">75</option>
        <option value="100">100</option>
      </select>
      <label for="sort">Sortieren nach:</label>
      <select name="sort" id="sort" formControlName="sort">
        <option value="top">Top</option>
        <option value="hot">Hot</option>
        <option value="new">New</option>
        <option value="rising">Rising</option>
      </select>
      <label for="time">Nur Posts der/des letzten</label>
      <select name="time" id="time" formControlName="time">
        <option value="hour">Stunde</option>
        <option value="day">Tages</option>
        <option value="week">Woche</option>
        <option value="month">Monat</option>
        <option value="all">Alle</option>
      </select>
      <label for="query">Posts nach query filtern:</label>
      <input type="text" name="query" id="query" formControlName="query">
    </form>
    <form [formGroup]="userPrefs" class="wrapper" novalidate>
      <label for="over18">ü18 Subreddits in Suchergebnissen anzeigen?:</label>
      <input type="checkbox" name="over18" id="over18" formControlName="over18">
      <label for="warn18">vor ü18 Posts mit ü18-Thumbnail warnen?:</label>
      <input type="checkbox" name="warn18" id="warn18" formControlName="warn18">
      <label for="warnSpoiler">vor Spoilern warnen?:</label>
      <input type="checkbox" name="warnSpoiler" id="warnSpoiler" formControlName="warnSpoiler">
    </form>
    <div *ngIf="userPrefs.dirty || postOptions.dirty">
      <h3>Änderungen wurden gespeichert ✔</h3>
      <button class="btn" (click)="hideOverlay($event,true)">jetzt auf neue Ergebnisse prüfen?</button>
    </div>
    <button class="advanced btn" (click)="advancedOptions.classList.toggle('none')">Lösch-Optionen:</button>
  </div>
  <div class="deleteCache none" #advancedOptions>
    <p class="warning">
      Info: Um Ergebnis besonders schnell anzuzeigen, werden geladene Posts zwischengespeichert.<br>
      Hier kannst du die gespeicherten Daten für Redditposts löschen<br>
      Das ist zB hilfreich, wenn dir fehlerhafter-weise alte Posts angezeigt werden <br>
      oder wenn du aktuellere Ergebnisse sehen willst<br><br>
      !Beachte: Es werden nur Ergebnisse der aktuellen Sitzung zwischengespeichert, <br>
      also wenn du den Browser oder den Tab schließt, wird der Speicher automatisch gelöscht.<br>
      Deshalb ist es meistens nicht notwendig hier manuell etwas zu löschen, die angezeigten Ergebnisse sind im Normalfall sehr aktuell.<br><br>
      Außerdem wird max 1x am Tag gecached, das bedeutet, morgen kriegst du automatisch aktuelle Ergebnisse!<br><br>
      !Achtung diese Optionen sollten nur benutzt werden, wenn du weißt was du tust!
    </p>
    <button class="options-specific btn warning" (click)="deleteCache('options-specific')" [disabled]="!store.getSaved(currentSub)">Cache für oben ausgewählte Optionen löschen</button>
    <button class="all btn danger" (click)="deleteCache('all')" [disabled]="!store.anySS()">kompletten Cache löschen</button>
  </div>
</div>

<app-gallery [posts]="posts" (loadMorePls)="loadMore()" (hideSuggestions)="suggestions=[]"></app-gallery>

<div *ngIf="err.length > 0" class="error">
  <span>Es tut uns Leid, dieser Subreddit konnte nicht angezeigt werden.</span><br><br>
  <u> Grund:</u>
  <ng-container [ngSwitch]="err">
    <span *ngSwitchCase="'private'"><br>
      Der Subreddit ist privat und kann deshalb nur eingeloggten Reddit-Nutzern angezeigt werden, die Mitglied dieses Subreddits sind.
      Wenn du Mitglied bist, dann kannst du es auf Reddit versuchen:
      <div style="text-align: center;">
        <a [href]="'http://www.reddit.com/r/'+ currentSub" target="_blank">{{ 'http://www.reddit.com/r/'+ currentSub }}</a>
      </div>
    </span>
    <span *ngSwitchCase="'banned'"><br>
      Der Subreddit wurde gebannt und kann deshalb nicht angezeigt werden.
    </span>
    <span *ngSwitchDefault>{{ err | json }}</span>
  </ng-container>
</div>

<ng-template #searchAndOptions>
  <div class="select">
    <div>
      <label>Zeige die 25 besten Posts von /r/</label>
      <div class="wrap-input">
        <button class="reset" (click)="subredditChooser.setValue('')" [ngStyle]="subredditChooser.value.length ? {} : {  'opacity': '0' }">x</button>
        <span *ngIf="!subExists && !suggestions.length">Subreddit existiert nicht</span>
        <input [formControl]="subredditChooser" [placeholder]="currentSub" [class]="subExists ? 'valid' : 'invalid'">
        <ul *ngIf="suggestions" class="suggestions">
          <li *ngFor="let sug of suggestions.slice(page, page+10)"
            [class.private]="sug.private" (click)="sug.private ? onPrivateClick() : fetchSub(sug.name, 'fill')">
            <span class="subscriber-count">{{sug.subscribers | shortNumber}}</span>
            <span *ngIf="sug.over18">🔞</span>
            {{sug.name}}</li>
        </ul>
      </div>
    </div>
    <div>
      <button class="btn" (click)="optionsOverlay.classList.toggle('fullscreen')">Optionen</button>
    </div>
  </div>
</ng-template>
